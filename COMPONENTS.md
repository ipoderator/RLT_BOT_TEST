# Описание компонентов системы

## Обзор

Этот документ содержит детальное описание каждого компонента системы RLT Bot.

---

## 1. Telegram Bot (`bot.py`)

### Назначение
Основной модуль приложения, точка входа для взаимодействия с пользователями через Telegram.

### Зависимости
- `aiogram` - фреймворк для работы с Telegram Bot API
- `VideoAnalytics` - класс для выполнения аналитических запросов
- `FileAnalyzer` - класс для анализа загруженных файлов

### Основные функции

#### Инициализация
```python
bot = Bot(token=TELEGRAM_BOT_TOKEN)
dp = Dispatcher()
analytics = VideoAnalytics(DATABASE_URL, GIGACHAT_CREDENTIALS, GIGACHAT_SCOPE)
file_analyzer = FileAnalyzer(GIGACHAT_CREDENTIALS, GIGACHAT_SCOPE)
```

#### Обработчики команд

**`/start`**
- Приветствие пользователя
- Инициализация сессии
- Отображение доступных команд

**`/clear_file`**
- Очистка загруженного JSON-файла
- Удаление из кэша
- Подтверждение очистки

**`/total_videos`, `/total_views`**
- Быстрые команды для частых запросов
- Прямой вызов аналитики без ввода текста

#### Обработка текстовых сообщений

1. Проверка наличия загруженного файла
2. Если файл есть - анализ через `FileAnalyzer`
3. Если файла нет - запрос к БД через `VideoAnalytics`
4. Возврат результата пользователю

#### Обработка файлов

- Прием JSON-файлов от пользователя
- Сохранение во временную директорию
- Передача в `FileAnalyzer` для обработки
- Удаление временных файлов после обработки

### Логирование

Использует `loguru` для логирования:
- Консольный вывод (INFO уровень, цветной)
- Файловый вывод (DEBUG уровень, ротация ежедневно)
- Логи хранятся в `logs/bot_YYYY-MM-DD.log`

---

## 2. Query Generator (`query_generator.py`)

### Назначение
Преобразование вопросов на естественном языке в SQL-запросы с помощью GigaChat API.

### Класс: `SQLQueryGenerator`

#### Методы

**`__init__(credentials: str, scope: str)`**
- Инициализация клиента GigaChat
- Настройка параметров API

**`generate_sql(question: str) -> str`**
- Нормализация вопроса
- Формирование промпта
- Отправка запроса в GigaChat
- Очистка и возврат SQL

**`_normalize_question(question: str) -> str`**
- Удаление лишних пробелов
- Нормализация чисел ("100 000" → "100000")
- Подготовка к обработке

**`_clean_sql_response(response: str) -> str`**
- Удаление markdown форматирования (```sql ... ```)
- Удаление комментариев (--, /* */)
- Удаление лишнего текста
- Возврат чистого SQL

### Промпт

Системный промпт включает:
1. Описание схемы БД (`DATABASE_SCHEMA`)
2. Правила безопасности (только SELECT)
3. Инструкции по обработке дат
4. Примеры вопросов и SQL-ответов
5. Правила форматирования ответа

### Особенности

- Поддержка русских дат: "28 ноября 2025" → `DATE '2025-11-28'`
- Обработка диапазонов: "с 1 по 5 ноября включительно" → `BETWEEN DATE '2025-11-01' AND DATE '2025-11-05'`
- Нормализация чисел с пробелами
- Обработка неоднозначных запросов

---

## 3. Query Executor (`query_executor.py`)

### Назначение
Выполнение SQL-запросов и извлечение результатов из базы данных.

### Класс: `VideoAnalytics`

#### Методы

**`__init__(db_url: str, gigachat_credentials: str, gigachat_scope: str)`**
- Сохранение параметров подключения
- Инициализация генератора SQL
- Создание пула соединений (ленивая инициализация)

**`answer_question(question: str) -> str`**
- Главный метод для ответа на вопрос
- Генерация SQL через `SQLQueryGenerator`
- Валидация SQL
- Выполнение запроса
- Форматирование результата

**`_get_pool() -> asyncpg.Pool`**
- Получение или создание пула соединений
- Парсинг DATABASE_URL
- Настройка параметров пула (min_size=1, max_size=5)

**`_validate_sql(sql: str) -> bool`**
- Проверка безопасности SQL-запроса
- Разрешены только SELECT-запросы
- Запрещены опасные операции

**`_execute_query(sql: str) -> Optional[float]`**
- Выполнение SQL через asyncpg
- Извлечение первого значения из результата
- Обработка NULL значений (возврат 0.0)
- Преобразование типов

**`_format_number(number) -> str`**
- Форматирование числа в строку
- Удаление пробелов
- Преобразование в целое число (если возможно)

**`close()`**
- Закрытие пула соединений
- Освобождение ресурсов

### Управление соединениями

- Использование пула соединений для эффективности
- Автоматическое управление жизненным циклом
- Обработка ошибок подключения

---

## 4. Database Models (`database.py`)

### Назначение
Определение моделей данных и инициализация базы данных.

### Модели

#### `Video`
Итоговая статистика по каждому видео.

**Поля**:
- `id` (Integer, Primary Key)
- `creator_id` (String, indexed) - идентификатор креатора
- `video_created_at` (DateTime) - дата публикации
- `views_count` (BigInteger) - итоговые просмотры
- `likes_count` (BigInteger) - итоговые лайки
- `comments_count` (BigInteger) - итоговые комментарии
- `reports_count` (BigInteger) - итоговые жалобы
- `created_at` (DateTime) - дата создания записи
- `updated_at` (DateTime) - дата обновления

**Связи**:
- `snapshots` - связь один-ко-многим с `VideoSnapshot`

#### `VideoSnapshot`
Почасовые снапшоты статистики для отслеживания динамики.

**Поля**:
- `id` (Integer, Primary Key, autoincrement)
- `video_id` (Integer, Foreign Key → videos.id, indexed)
- `views_count` (BigInteger) - просмотры на момент замера
- `likes_count` (BigInteger) - лайки на момент замера
- `comments_count` (BigInteger) - комментарии на момент замера
- `reports_count` (BigInteger) - жалобы на момент замера
- `delta_views_count` (BigInteger) - приращение просмотров
- `delta_likes_count` (BigInteger) - приращение лайков
- `delta_comments_count` (BigInteger) - приращение комментариев
- `delta_reports_count` (BigInteger) - приращение жалоб
- `created_at` (DateTime, indexed) - время замера
- `updated_at` (DateTime) - дата обновления

**Связи**:
- `video` - связь многие-к-одному с `Video`

### Функции

**`init_db(database_url: str) -> Engine`**
- Создание всех таблиц в БД
- Использование SQLAlchemy для миграций
- Возврат Engine объекта

**`get_session(engine) -> Session`**
- Создание сессии SQLAlchemy
- Использование для синхронных операций (загрузка данных)

---

## 5. File Analyzer (`file_analyzer.py`)

### Назначение
Анализ загруженных JSON-файлов и ответы на вопросы по их содержимому через GigaChat.

### Класс: `FileAnalyzer`

#### Методы

**`__init__(gigachat_credentials: str, gigachat_scope: str)`**
- Инициализация клиента GigaChat
- Настройка кэша файлов

**`load_file(file_path: str, file_name: str = None)`**
- Загрузка и кэширование файла
- Вычисление хеша для идентификации
- Сохранение метаданных

**`clear_file()`**
- Очистка текущего файла
- Удаление из кэша

**`analyze(question: str) -> str`**
- Анализ файла через GigaChat
- Формирование промпта с данными файла
- Возврат ответа на вопрос

**`_get_client() -> GigaChat`**
- Получение или создание клиента GigaChat
- Ленивая инициализация

**`_load_cached_file(file_hash: str) -> Optional[Dict]`**
- Загрузка файла из кэша
- Проверка существования

**`_save_to_cache(file_path: str, file_hash: str) -> str`**
- Сохранение файла в кэш
- Обновление метаданных

### Кэширование

- Файлы кэшируются по хешу содержимого
- Метаданные хранятся в `cache/metadata.json`
- Автоматическая очистка старых файлов
- Экономия трафика и времени при повторной загрузке

---

## 6. Data Loader (`load_data.py`)

### Назначение
Загрузка данных из JSON-файлов в базу данных PostgreSQL.

### Функции

**`download_json(url: str, save_path: str = None) -> str`**
- Скачивание JSON-файла по URL
- Сохранение локально
- Возврат пути к файлу

**`load_data_from_json(json_file: str, database_url: str)`**
- Парсинг JSON-файла
- Создание записей в таблице `videos`
- Создание снапшотов в таблице `video_snapshots`
- Вычисление дельт между снапшотами

### Процесс загрузки

1. Парсинг JSON:
   - Извлечение данных о видео
   - Извлечение снапшотов для каждого видео

2. Создание записей Video:
   - Одна запись на видео
   - Итоговые значения статистики

3. Создание снапшотов:
   - Множество записей на видео (по часам)
   - Вычисление дельт (разница с предыдущим снапшотом)

4. Сохранение в БД:
   - Использование SQLAlchemy для транзакций
   - Обработка ошибок и откат при необходимости

---

## Взаимодействие компонентов

### Схема зависимостей

```
bot.py
├── query_executor.py (VideoAnalytics)
│   └── query_generator.py (SQLQueryGenerator)
│       └── gigachat (GigaChat API)
├── file_analyzer.py (FileAnalyzer)
│   └── gigachat (GigaChat API)
└── database.py (модели данных)

load_data.py
└── database.py (модели данных)
```

### Потоки данных

1. **Запрос пользователя → Ответ**
   - `bot.py` → `VideoAnalytics` → `SQLQueryGenerator` → GigaChat → PostgreSQL → Ответ

2. **Загрузка файла → Анализ**
   - `bot.py` → `FileAnalyzer` → GigaChat → Ответ

3. **Загрузка данных в БД**
   - `load_data.py` → `database.py` → PostgreSQL

---

## Рекомендации по использованию

### Для разработчиков

1. **Добавление новых типов запросов**:
   - Обновить `DATABASE_SCHEMA` в `query_generator.py`
   - Добавить примеры в `SYSTEM_PROMPT`

2. **Оптимизация производительности**:
   - Добавить индексы в БД для частых запросов
   - Настроить размер пула соединений

3. **Расширение функциональности**:
   - Добавить новые команды в `bot.py`
   - Расширить модели данных в `database.py`

### Для тестирования

- Использовать `test_*.py` скрипты для проверки функциональности
- Проверять логи в `logs/` для отладки
- Использовать `check_db_compliance.py` для проверки структуры БД

