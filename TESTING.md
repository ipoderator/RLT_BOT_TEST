# Руководство по тестированию бота

Этот документ описывает скрипты для проверки всех требований к Telegram-боту.

## Доступные скрипты тестирования

### 1. `test_requirements.py` - Комплексная проверка всех требований

Основной скрипт для проверки всех требований из технического задания.

**Запуск:**
```bash
python test_requirements.py
```

**Что проверяет:**
- Развертывание базы данных (таблицы, колонки, индексы)
- Загрузка данных из JSON
- Используемые технологии (Python, PostgreSQL, aiogram и т.д.)
- Работа Telegram-бота (настройки, методы)
- Распознавание естественного языка (промпты, валидация SQL)
- Корректность ответов на примеры вопросов
- Формат ответов (одно число)
- Отсутствие контекста диалога
- Обработка ошибок

**Вывод:**
- Детальный отчет по каждому разделу проверки
- Итоговая сводка с процентом успешных проверок
- Список найденных ошибок

---

### 2. `test_bot.py` - Тестирование примеров вопросов

Проверяет работу системы аналитики на примерах вопросов из ТЗ.

**Запуск:**
```bash
python test_bot.py
```

**Что проверяет:**
- Все примеры вопросов из технического задания
- Формат ответов (должно быть число)
- Корректность выполнения запросов

**Примеры вопросов:**
- "Сколько всего видео есть в системе?"
- "Сколько видео набрало больше 100000 просмотров за всё время?"
- "На сколько просмотров в сумме выросли все видео 28 ноября 2025?"
- "Сколько разных видео получали новые просмотры 27 ноября 2025?"

---

### 3. `test_sql_generation.py` - Детальная проверка генерации SQL

Проверяет корректность SQL запросов, генерируемых для различных типов вопросов.

**Запуск:**
```bash
python test_sql_generation.py
```

**Что проверяет:**
- Паттерны SQL запросов для каждого типа вопроса
- Использование правильных таблиц (videos vs video_snapshots)
- Корректность фильтров и условий
- Валидацию безопасности SQL
- Выполнение запросов и формат ответов

---

### 4. `test_database_structure.py` - Проверка структуры БД

Проверяет структуру базы данных: таблицы, колонки, индексы, внешние ключи.

**Запуск:**
```bash
python test_database_structure.py
```

**Что проверяет:**
- Наличие таблиц `videos` и `video_snapshots`
- Наличие всех требуемых колонок
- Наличие индексов (включая составной индекс)
- Внешние ключи
- Количество загруженных данных

---

## Порядок выполнения проверок

### Шаг 1: Подготовка окружения

1. Убедитесь, что PostgreSQL установлен и запущен
2. Создайте базу данных:
   ```sql
   CREATE DATABASE video_analytics;
   ```
3. Настройте `.env` файл с переменными:
   - `TELEGRAM_BOT_TOKEN`
   - `OPENAI_API_KEY`
   - `DATABASE_URL`

### Шаг 2: Загрузка данных

```bash
python load_data.py <путь_к_json_файлу>
```

### Шаг 3: Проверка структуры БД

```bash
python test_database_structure.py
```

Должна быть успешно пройдена проверка всех таблиц и колонок.

### Шаг 4: Проверка генерации SQL

```bash
python test_sql_generation.py
```

Проверяет, что SQL генерируется корректно для всех типов запросов.

### Шаг 5: Тестирование примеров вопросов

```bash
python test_bot.py
```

Проверяет работу системы на примерах из ТЗ.

### Шаг 6: Комплексная проверка всех требований

```bash
python test_requirements.py
```

Выполняет полную проверку всех требований и выводит итоговую сводку.

---

## Интерпретация результатов

### Успешная проверка

- ✅ Все проверки пройдены
- Процент успешных проверок ≥ 90%
- Нет критических ошибок

### Требуется внимание

- ⚠️ Некоторые проверки не пройдены
- Процент успешных проверок 70-90%
- Есть некритические замечания

### Требуется доработка

- ❌ Много проверок не пройдено
- Процент успешных проверок < 70%
- Есть критические ошибки

---

## Ручное тестирование через Telegram

После успешного прохождения автоматических тестов можно протестировать бота вручную:

1. Запустите бота:
   ```bash
   python bot.py
   ```

2. Найдите бота в Telegram и отправьте команду `/start`

3. Протестируйте примеры вопросов:
   - "Сколько всего видео есть в системе?"
   - "Сколько видео у креатора с id creator123 вышло с 1 ноября 2025 по 5 ноября 2025 включительно?"
   - "Сколько видео набрало больше 100000 просмотров за всё время?"
   - "На сколько просмотров в сумме выросли все видео 28 ноября 2025?"
   - "Сколько разных видео получали новые просмотры 27 ноября 2025?"

4. Проверьте формат ответов:
   - Должно быть одно число
   - Без дополнительного текста
   - При отсутствии данных: "Данные не найдены" или "0"

---

## Устранение проблем

### Ошибка подключения к БД

- Проверьте, что PostgreSQL запущен
- Проверьте правильность `DATABASE_URL` в `.env`
- Убедитесь, что база данных создана

### Ошибка генерации SQL

- Проверьте наличие `OPENAI_API_KEY` в `.env`
- Проверьте баланс API ключа OpenAI
- Проверьте интернет-соединение

### Ошибка выполнения SQL

- Проверьте, что данные загружены в БД
- Проверьте логи ошибок
- Убедитесь, что SQL запрос валиден

### Неправильный формат ответа

- Проверьте код в `query_executor.py`
- Убедитесь, что результат преобразуется в строку
- Проверьте обработку случаев с отсутствием данных
